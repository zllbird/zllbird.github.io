<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Coder-bird &middot; 诸隆隆</title>

  
  <link rel="stylesheet" href="https://zllbird.github.io/css/poole.css">
  <link rel="stylesheet" href="https://zllbird.github.io/css/hyde.css">
  <link rel="stylesheet" href="https://zllbird.github.io/css/poole-overrides.css">
  <link rel="stylesheet" href="https://zllbird.github.io/css/hyde-overrides.css">
  <link rel="stylesheet" href="https://zllbird.github.io/css/hyde-x.css">
  <link rel="stylesheet" href="https://zllbird.github.io/css/highlight/sunburst.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://zllbird.github.io/touch-icon-144-precomposed.png">
  <link href="https://zllbird.github.io/favicon.png" rel="icon">

  
  
  
  <link href="https://zllbird.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Coder-bird &middot; 诸隆隆" />

  <meta name="description" content="我是一只小小鸟">
  <meta name="keywords" content="">
  
</head>
<body>
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      
      <h1>诸隆隆</h1>
      <p class="lead">我要飞的更高</p>
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item"><a href="https://zllbird.github.io/">Blog</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="zllbird"><i class="fa fa-github-square fa-3x"></i></a>
      
      
      
      
      <a href="%e8%af%b8%e9%9a%86%e9%9a%86"><i class="fa fa-facebook-square fa-3x"></i></a>
      <a href="%e8%af%b8%e9%9a%86%e9%9a%86"><i class="fa fa-twitter-square fa-3x"></i></a>
      
      
      </li>
    </ul>

    

    <p>Copyright &copy; 2016 <a href="https://zllbird.github.io/license/">License</a><br/>
       Powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://github.com/zyro/hyde-x">Hyde-X</a></p>
  </div>
</div>


<div class="content container">
  <div class="posts">
    
    
    <div class="post">
      <h1 class="post-title">
        <a href="https://zllbird.github.io/2015/11/30/android%E8%87%AA%E5%8A%A8%E6%9E%84%E5%BB%BA/">Android自动构建</a>
      </h1>
      <span class="post-date">Nov 30, 2015 &middot; 1 minute read &middot; <a href="https://zllbird.github.io/2015/11/30/android%E8%87%AA%E5%8A%A8%E6%9E%84%E5%BB%BA/#disqus_thread">Comments</a>
      
      <br/>
      <a class="label" href="https://zllbird.github.io/categories/%E5%BC%80%E5%8F%91">开发</a>
      </span>
      
      

<h1 id="android自动构建发布实践:8595cf9f458882a0b67b0f8cac9fde62">Android自动构建发布实践</h1>

<p>首先声明。</p>

<p><strong>这主要不是讲教程，这是集成过程中遇到的坑！</strong></p>

<p><strong>这主要不是讲教程，这是集成过程中遇到的坑！</strong></p>

<p><strong>这主要不是讲教程，这是集成过程中遇到的坑！</strong></p>

<p>重要的事情说三遍。</p>

<h3 id="集成工具:8595cf9f458882a0b67b0f8cac9fde62">集成工具</h3>

<ul>
<li>jenkins (CI)</li>
<li>Git and GitLab(GitHub同理)</li>
<li>Gradle (build 工具)</li>
<li>fir （发布工具）</li>
</ul>

<p>工具简单介绍一下，</p>

<p>jenkins是现在比较主流的CI，也正是因此，上面的插件丰富，涵盖面也很广，更为重要的是，非常容易安装和配置，自然是首选。</p>

<p>Git 版本管理工具，就不用了讲解了。jenkins同时支持svn。（还是建议大家早点转到git上）公司现在的版本管理使用的是gitlab，类似github(github的迷你版)。</p>

<p>Gradle是现任Android构建，很是强大。至于grade配置，网上教程很多也很杂乱，建议大家跟随谷歌原版[Gradle 用户指南]()</p>

<p>这里再推荐一篇，个人认为对Gradle解读很到位的一篇文章。[深入理解gradle]()</p>

<h3 id="开始集成:8595cf9f458882a0b67b0f8cac9fde62">开始集成</h3>

<p>安装jenkins。</p>

<p>如果你是mac或者Linux，可以直接通过shell安装（<strong>推荐</strong> ）</p>

<pre><code>$ brew install jenkins 
</code></pre>

<p>如果没有brew，先安装Homebrew</p>

<pre><code> $ ruby -e &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)&quot;
</code></pre>

<p>如果没有ruby&hellip; 请自行google。</p>

<p>启动 Jenkins</p>

<pre><code>$ jenkins
</code></pre>

<h3 id="访问-jenkins:8595cf9f458882a0b67b0f8cac9fde62">访问 Jenkins</h3>

<ul>
<li>请在浏览器输入地址:</li>
</ul>

<pre><code>    http://localhost:8080/
  
</code></pre>

<ul>
<li>使用安装包安装后会自动打开，如果端口冲突那么请修改端口</li>
</ul>

<pre><code>    defaults write /Library/Preferences/org.jenkins-ci httpPort xxxx
  
</code></pre>

<p>jenkins最基本的安装就完成了。然后，可以在浏览器输入地址查看一下。看到这样的画面，基本安装就完成了。</p>

<p><img src="https://zllbird.github.io/images/jenkins/initjenkins.png" alt="initjenkins" /></p>

<p>截图里包含两个，一个是通过web端浏览器访问得到的界面。另一个是shell的日志。</p>

<p>jenkins到此结束。开始使用jenkins，Android的构建之旅吧。</p>

<h3 id="jenkins的插件安装:8595cf9f458882a0b67b0f8cac9fde62">jenkins的插件安装</h3>

<p>两种方式。这里以安装Git插件为例。</p>

<ol>
<li>通过查询安装。</li>
<li>通过自行下载*.hpi , 然后通过高级安装。</li>
</ol>

<p>选择系统管理，然后选择管理插件。 <img src="https://zllbird.github.io/images/jenkins/initpulgin.png" alt="initpulgin" /></p>

<h4 id="查询安装:8595cf9f458882a0b67b0f8cac9fde62">查询安装。</h4>

<p>在插件管理界面，选择可选插件，然后在右边过滤器里筛选Git或GIT plugin</p>

<p><img src="https://zllbird.github.io/images/jenkins/jenkinsgit.png" alt="jenkinsgit" /></p>

<p>然后选择立刻安装。</p>

<h4 id="自行下载-hpi-然后通过高级安装:8595cf9f458882a0b67b0f8cac9fde62">自行下载*.hpi , 然后通过高级安装</h4>

<p><img src="https://zllbird.github.io/images/jenkins/jenkinscuston.png" alt="jenkinscuston" /></p>

<p>然后选择上传。</p>

<h4 id="遇到的坑:8595cf9f458882a0b67b0f8cac9fde62">遇到的坑</h4>

<p>可以说刚开始我是一只使用第一种方法来安装插件的。结果失败率非常高。如果不自备梯子，失败率会更高！</p>

<p><em>折腾了很长时间，而且搞得自己心里憔悴。</em></p>

<p>所以建议大家通过自己去jenkins的官网或镜像来下载hpi文件自行安装需要的插件。</p>

<p>还有，自备梯子是一种好习惯。</p>

<h4 id="需要安装的插件:8595cf9f458882a0b67b0f8cac9fde62">需要安装的插件</h4>

<ul>
<li>Git</li>
<li>Gitlab</li>
<li>Gitlab Hook (我一直安装不成功，所以自动push event 构建也还未成功)</li>
<li>Gradle</li>
<li>fir （官网有详尽的<a href="http://blog.fir.im/jenkins/">下载和安装教程</a>）</li>
</ul>

<p>到此为止，所有的环境都准备好了。终于可以开动了！</p>

<h3 id="自动化构建实例:8595cf9f458882a0b67b0f8cac9fde62">自动化构建实例</h3>

<p>jenkins中新建一个项目，命名后，选择 <code>构建一个自由风格的软件项目</code>。</p>

<p>项目名称。<strong>跳过</strong></p>

<p>描述。<strong>跳过</strong></p>

<p>… 各种跳过，直接进入源码管理。</p>

<h4 id="源码管理:8595cf9f458882a0b67b0f8cac9fde62">源码管理</h4>

<p><img src="https://zllbird.github.io/images/jenkins/jenkinssource.png" alt="jenkinssource" /></p>

<p>这里选的是Git，当然如果你只有现实svn的话，那就是你还没安装Git的插件，具体安装请看上文。</p>

<p>记住选择构建的分支。（这里是一个只含一个界面调试的项目，所以我直接用了master。<strong>建议，创建一个deploy发布或者debug这样的分支</strong>，确保每次构建都是可控的。）</p>

<p>注意到Credentials，这是身份验证。这里直接写了none，也就是说，没有直接验证身份。难道说，我的项目没加任何限制？？？</p>

<p>当然，不是啦。Git的项目，无论是Github还是自己搭建的Gitlab，大多数都是通过ssh验证的。</p>

<p>可以点击Credentials 后面的Add 。</p>

<p><img src="https://zllbird.github.io/images/jenkins/jenkinsssh.png" alt="jenkinsssh" /></p>

<p>这样保证jenkins部署的机器的ssh私钥在服务上。</p>

<h4 id="构建触发器:8595cf9f458882a0b67b0f8cac9fde62">构建触发器</h4>

<p>这就是传说中的<strong>自动构建</strong>。直接上图讲解。</p>

<p><img src="https://zllbird.github.io/images/jenkins/jenkinsauto.png" alt="jenkinsauto" /></p>

<p>这里有三种事件触发构建。</p>

<ul>
<li>Build periodically 。 即定时触发，这里我写的是<code>H 10 * * *</code>，指的就是每天10点触发构建，也就是说，每天10天无论有没有新的代码部署，都会进行构建。</li>
</ul>

<pre><code>  H 10 * * *
  分 小时 天 月 年
  
  // 五位分别指向轮询事件，这里H 和 0 差不多意思，就是不顾及 分，每天10天构建。
  // * 指忽视
</code></pre>

<ul>
<li><p>Build when a change is pushed to GitLab. GitLab CI Service UR… 。这是Gitlab的插件，是gitlab通过事件通知的形式发放。（我测试了很久，感觉这个插件时好时坏，不建议使用）</p></li>

<li><p>Poll SCM。 即轮询查询仓库中的代码是否有更新，如果有更新，则进行构建。没有更新，则忽视。这里写的<code>H/5 * * * *</code>，指每五分钟进行代码扫描。</p></li>
</ul>

<pre><code>H/5  指每五分钟。 这种写法指每这段时间进行轮询
</code></pre>

<h4 id="构建:8595cf9f458882a0b67b0f8cac9fde62">构建</h4>

<p>构建栏中，选增加构建步骤。选择<code>Invoke Gradle script</code>，当然，如果没有这个选项，就是未安装Gradle插件，然后具体的参数。</p>

<p><img src="https://zllbird.github.io/images/jenkins/jenkinsbuild.png" alt="jenkinsbuild" /></p>

<p>熟悉Gradle的，很容易看明白，只是执行了了gradle clean build 指令而已。不熟悉的也没关系，我会单独再写一篇关于优化Gradle在安卓上面的部署的 ，以及Gradle使用。</p>

<h4 id="构建后操作:8595cf9f458882a0b67b0f8cac9fde62">构建后操作</h4>

<p>我这里使用的是fir.im （做的还不错哦）。</p>

<p>选择增加构建后操作步奏，选择<code>Upload to fir.im</code>。 <img src="https://zllbird.github.io/images/jenkins/jenkinsfir.png" alt="jenkinsfir" /></p>

<p>Token 需要注册fir后生成。</p>

<p>IPA/APK Files ,是可选项。如果不填写，会直接从目录里找。如果填写了，则是会找到需要的目录。</p>

<p>其他的涉及到测试等方面。不是本文涉及的内容。</p>

<p>以上全部内容都是在自己mac上执行完成的。</p>

<p>接下来在Linux上部署。</p>

<p>到此构建基本完成。</p>

<hr />

      
    </div>
    
    
    
    <ul class="pagination">
        
        <li>
            <a href="/" aria-label="First"><span aria-hidden="true">&laquo;&laquo;</span></a>
        </li>
        
        <li
        >
        <a href="/page/2/" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
        </li>
        
        <li
        ><a href="/">1</a></li>
        
        <li
        ><a href="/page/2/">2</a></li>
        
        <li
        class="active"><a href="/page/3/">3</a></li>
        
        <li
        ><a href="/page/4/">4</a></li>
        
        <li
        ><a href="/page/5/">5</a></li>
        
        <li
        ><a href="/page/6/">6</a></li>
        
        <li
        ><a href="/page/7/">7</a></li>
        
        <li
        ><a href="/page/8/">8</a></li>
        
        <li
        ><a href="/page/9/">9</a></li>
        
        <li
        ><a href="/page/10/">10</a></li>
        
        <li
        >
        <a href="/page/4/" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>
        </li>
        
        <li>
            <a href="/page/10/" aria-label="Last"><span aria-hidden="true">&raquo;&raquo;</span></a>
        </li>
        
    </ul>
    
  </div>
</div>


<script type="text/javascript">
var disqus_shortname = "ZllBird";
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>

<script src="https://zllbird.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

</body>
</html>

